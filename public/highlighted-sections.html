<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Highlighted Sections</title>
  <link rel="icon" type="image/png" href="assets/images/icon.png">
  <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
  <style>
    .post-tile {
      display: inline-block;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }
    .post-tile:hover {
      background-color: #f2f2f2;
    }
    .post-tile.selected {
      background-color: #007bff;
      color: #fff;
      border-color: #007bff;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h2>Manage Highlighted Sections</h2>
    <p class="text-muted">Click post IDs to select/unselect.</p>

    <form id="highlightForm">
      <div class="mb-4">
        <h4>Top Stories (4)</h4>
        <div id="topStoriesTiles" class="tile-container"></div>
      </div>

      <div class="mb-4">
        <h4>Most Popular (4)</h4>
        <div id="mostPopularTiles" class="tile-container"></div>
      </div>

      <div class="mb-4">
        <h4>In Focus (5)</h4>
        <div id="inFocusTiles" class="tile-container"></div>
      </div>

      <button type="submit" class="btn btn-primary">Save Changes</button>
      <a href="admin-dashboard.html" class="btn btn-secondary">Cancel</a>
    </form>
  </div>

  <script>
    async function loadData() {
      // Load all posts
      const postsRes = await fetch('/api/post');
      const posts = await postsRes.json();

      // Load current highlighted sections
      const highlightRes = await fetch('/api/highlighted-sections', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      let highlighted = { topStories: [], mostPopular: [], inFocus: [] };
      if (highlightRes.ok) {
        const data = await highlightRes.json();
        if (data) highlighted = data;
      }

      renderTiles(posts, highlighted);
    }

    function renderTiles(posts, highlighted) {
      const sections = [
        { id: 'topStoriesTiles', max: 4, selectedIds: (highlighted.topStories || []).map(Number) },
        { id: 'mostPopularTiles', max: 4, selectedIds: (highlighted.mostPopular || []).map(Number) },
        { id: 'inFocusTiles', max: 5, selectedIds: (highlighted.inFocus || []).map(Number) },
      ];

      sections.forEach(section => {
        const container = document.getElementById(section.id);
        container.innerHTML = ''; // clear if re-rendered
        posts.forEach(post => {
          const tile = document.createElement('div');
          tile.classList.add('post-tile');
          tile.textContent = post.id;
          tile.dataset.id = post.id;

          // Force numeric comparison to ensure pre-selection works
          if (section.selectedIds.includes(Number(post.id))) {
            tile.classList.add('selected');
          }

          container.appendChild(tile);
        });
        setupTileSelection(section.id, section.max);
      });
    }

    function setupTileSelection(containerId, maxSelection) {
      const container = document.getElementById(containerId);
      container.addEventListener('click', (e) => {
        if (!e.target.classList.contains('post-tile')) return;

        if (e.target.classList.contains('selected')) {
          e.target.classList.remove('selected');
        } else {
          const selected = container.querySelectorAll('.post-tile.selected').length;
          if (selected < maxSelection) {
            e.target.classList.add('selected');
          } else {
            alert(`You can select only ${maxSelection} posts for this section.`);
          }
        }
      });
    }

    document.getElementById('highlightForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const topStories = Array.from(document.querySelectorAll('#topStoriesTiles .post-tile.selected')).map(t => parseInt(t.dataset.id));
      const mostPopular = Array.from(document.querySelectorAll('#mostPopularTiles .post-tile.selected')).map(t => parseInt(t.dataset.id));
      const inFocus = Array.from(document.querySelectorAll('#inFocusTiles .post-tile.selected')).map(t => parseInt(t.dataset.id));

      if (topStories.length !== 4 || mostPopular.length !== 4 || inFocus.length !== 5) {
        return alert('Please select exactly 4 Top Stories, 4 Most Popular, and 5 In Focus posts.');
      }

      const payload = { topStories, mostPopular, inFocus };

      const response = await fetch('/api/highlighted-sections', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      if (result.status === 'success') {
        alert('Highlighted sections updated successfully!');
        window.location.href = 'admin-dashboard.html';
      } else {
        alert('Failed to update highlighted sections.');
      }
    });

    loadData();
  </script>
</body>
</html>