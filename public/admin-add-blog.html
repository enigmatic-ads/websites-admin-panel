<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add New Blog</title>
  <link rel="icon" type="image/png" href="assets/images/icon.png">
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.tiny.cloud/1/0cs91s6vtnabifnqn7entz26k8icrwh6ke0ucut7a9r75n9h/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
  <style>
    body { padding: 2rem; }
    textarea { resize: vertical; }
    .section-block { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
  </style>
</head>
<body>

  <div class="mr-4">
    <a href="admin-dashboard.html" class="btn btn-primary">Back</a>
  </div>

  <div class="container">
    <h2>Add New Blog</h2>
    <form id="blogForm" enctype="multipart/form-data">

      <div class="form-group">
        <label for="title">Main Title</label>
        <input id="title" class="form-control" required />
      </div>

      <div class="form-group">
        <label for="image">Main Image</label>
        <input id="image" type="file" class="form-control" accept="image/*" required />
      </div>

      <div class="form-group">
        <label for="summary">Summary</label>
        <textarea id="summary" class="form-control" rows="2" required></textarea>
      </div>

      <h4>Content Sections</h4>
      <div id="sectionsContainer"></div>
      <button type="button" id="addSectionBtn" class="btn btn-secondary mb-3">+ Add Section</button>

      <div class="form-group">
        <label for="categorySelector">Select Category</label>
        <select id="categorySelector" class="form-control" required>
          <option value="">-- Select category --</option>
        </select>
      </div>

      <div>
        <button type="submit" class="btn btn-success">Add Blog</button>
      </div>
      
    </form>
  </div>

  <script>
    let sectionCount = 0;

    // Function to renumber all remaining sections
    function renumberSections() {
      const sectionBlocks = document.querySelectorAll('.section-block');
      sectionBlocks.forEach((block, index) => {
        const newNumber = index + 1;
        const heading = block.querySelector('h5');
        heading.textContent = `Section ${newNumber}`;
        block.id = `section-${newNumber}`;
      });
      sectionCount = sectionBlocks.length;
    }

    // Add new section
    document.getElementById('addSectionBtn').addEventListener('click', () => {
      sectionCount++;
      const sectionId = `section-${sectionCount}`;

      const sectionHtml = `
        <div class="section-block" id="${sectionId}">
          <h5>Section ${sectionCount}</h5>
          <div class="form-group">
            <label>Section Title (optional)</label>
            <input type="text" class="form-control section-title" />
          </div>
          <div class="form-group">
            <label>Section Image (optional)</label>
            <input type="file" class="form-control section-image" accept="image/*" />
          </div>
          <div class="form-group">
            <label>Section Content</label>
            <textarea class="section-editor"></textarea>
          </div>
          <button type="button" class="btn btn-danger remove-section">Remove</button>
        </div>
      `;

      document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', sectionHtml);

      // Init TinyMCE for this section
      tinymce.init({
        selector: `#${sectionId} .section-editor`,
        height: 300,
        menubar: false,
        plugins: 'link image code lists',
        toolbar: 'undo redo | styleselect | bold italic underline | alignleft aligncenter alignright | bullist numlist | link code'
      });

      // Add remove functionality
      document.querySelector(`#${sectionId} .remove-section`).addEventListener('click', (e) => {
        e.target.closest('.section-block').remove();
        renumberSections();
      });
    });

    // Handle category checkbox (only one selection)
    document.querySelectorAll('.category-checkbox').forEach(cb => {
      cb.addEventListener('change', function () {
        if (this.checked) {
          document.querySelectorAll('.category-checkbox').forEach(other => {
            if (other !== this) other.checked = false;
          });
        }
      });
    });

    // Submit form
    document.getElementById("blogForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = document.getElementById("title").value;
      const summary = document.getElementById("summary").value;
      const mainImage = document.getElementById("image").files[0];
      const selectedCategory = document.getElementById("categorySelector").value;

      // Collect sections data
      const sections = [];
      document.querySelectorAll('.section-block').forEach((block, index) => {
        const sectionTitle = block.querySelector('.section-title').value;
        const sectionImage = block.querySelector('.section-image').files[0];
        const editorId = block.querySelector('.section-editor').id;
        let sectionContent = tinymce.get(editorId)?.getContent() || '';
        sectionContent = sectionContent
          .replace(/<p[^>]*>/gi, '')
          .replace(/<\/p>/gi, '<br><br>')
          .replace(/<span[^>]*>/gi, '')
          .replace(/<\/span>/gi, '')
          .replace(/<\/h[1-6]>/gi, '$&<br>')
          .replace(/<\/(ul|ol)>(?!<br>)/gi, '</$1><br>')
          .replace(/<hr>/gi, '');

        sections.push({ sectionTitle, sectionImage, sectionContent });
      });

      const formData = new FormData();
      formData.append("title", title);
      formData.append("summary", summary);
      formData.append("image", mainImage);
      formData.append("category", selectedCategory);
      formData.append("sections", JSON.stringify(sections));

      // Append section images separately
      sections.forEach((s, i) => {
        if (s.sectionImage) {
          formData.append(`sectionImage_${i}`, s.sectionImage);
        }
      });

      const response = await fetch("/api/post", {
        method: "POST",
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
        body: formData
      });

      const result = await response.json();
      if (result.status === "success") {
        alert("Blog post saved!");
        window.location.href = "admin-dashboard.html";
      } else {
        alert("Failed to save post.");
      }
    });
  </script>

  <script>
    // Define categories per site
    const siteCategories = {
      aboutfashions: [
        "Fashion Trends",
        "Style Tips",
        "Beauty & Makeup",
        "Shopping"
      ],
      genexfinance: [
        "Financial Planning",
        "Investment",
        "Banking",
        "Insurance"
      ],
      foodbitez: [
        "Nutrition Basics",
        "Food & Health",
        "Special Diets"
      ],
      thefactfinding: [
        "History & Culture",
        "Science & Technology",
        "Bizzare & Unexplained",
        "Human Psychology"
      ],
      kafeyworld: [
        "Culinary Delights",
        "Events",
        "Dietary Options",
        "Seasonal Options"
      ],
      nurturelifes: [
        "Parenting",
        "Care & Development",
        "Lifestyle",
        "Health & Wellness"
      ],
      homeztravel: [
        "Destinations",
        "Cultural Immersion",
        "Food & Dining",
        "Travel Tech & Gear"
      ],
      thetechgadgetz: [
        "Tech News",
        "Gadget Reviews",
        "Future Tech",
        "How To Guide"
      ]
    };

    const categorySelector = document.getElementById('categorySelector');

    // Function to read cookie by name
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Get selected site from cookie
    const selectedSite = getCookie('selectedSite');

    if (!selectedSite) {
      alert('No site selected. Please select a site first.');
      window.location.href = 'admin-dashboard.html';
    } else {
      // Fill categories based on cookie value
      const categories = siteCategories[selectedSite];
      if (categories) {
        categorySelector.innerHTML = '<option value="">-- Select category --</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelector.appendChild(option);
        });
      } else {
        alert(`No categories defined for site: ${selectedSite}`);
      }
    }
  </script>


</body>
</html>